# lib/designate_plugins/backend-bind9
# Configure the bind9 backend

# Enable with:
# DESIGNATE_BACKEND_DRIVER=bind9

# Dependencies:
# ``functions`` file
# ``designate`` configuration

# install_designate_backend - install any external requirements
# configure_designate_backend - make configuration changes, including those to other services
# init_designate_backend - initialize databases, etc.
# start_designate_backend - start any external services
# stop_designate_backend - stop any external services
# cleanup_designate_backend - remove transient data and cache

# Save trace setting
XTRACE=$(set +o | grep xtrace)
set +o xtrace

# Defaults
# --------

# Entry Points
# ------------

# install_designate_backend - install any external requirements
function install_designate_backend {
    install_package bind9
}

# configure_designate_backend - make configuration changes, including those to other services
function configure_designate_backend {
    iniset $DESIGNATE_CONF backend:bind9 rndc_port '953'
    iniset $DESIGNATE_CONF backend:bind9 rndc_host '127.0.0.1'
    iniset $DESIGNATE_CONF backend:bind9 rndc_config_file  '/etc/bind/rndc.conf'
    iniset $DESIGNATE_CONF backend:bind9 rndc_key_file  '/etc/bind/rndc.key'

    sudo chown $USER /etc/bind/

    if is_ubuntu; then
        sudo touch /etc/apparmor.d/disable/usr.sbin.named
        sudo service apparmor reload
        sudo tee /etc/bind/named.conf.options > /dev/null <<EOF
options {
    directory "/var/cache/bind";
    allow-new-zones yes;
    dnssec-validation auto;
    auth-nxdomain no;    # conform to RFC1035
    listen-on-v6 { any; };
};
EOF

        sudo tee /etc/bind/rndc.conf > /dev/null <<EOF
include "/etc/bind/rndc.key";
options {
    default-key "rndc-key";
    default-server 127.0.0.1;
    default-port 953;
};
EOF
    else
        echo "Designate DevStack bind9 implementation is Ubuntu-only"
        exit 1
    fi

    restart_service bind9
}

# init_designate_backend - initialize databases, etc.
function init_designate_backend {
    :
}

# start_designate_backend - start any external services
function start_designate_backend {
    start_service bind9
}

# stop_designate_backend - stop any external services
function stop_designate_backend {
    stop_service bind9
}

# cleanup_designate_backend - remove transient data and cache
function cleanup_designate_backend {
    :
}

# Restore xtrace
$XTRACE
